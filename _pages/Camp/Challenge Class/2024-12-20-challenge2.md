---
title: "IOCP"
tags:
  - 캠프
  - CHALLENGE CLASS
date: "2024-12-20"
thumbnail: "/assets/img/thumbnail/sample.png"
bookmark: true
---

# **IOCP (I/O Completion Port)**

---

IOCP는 Windows 운영 체제에서 **비동기 입출력(Asynchronous I/O)** 작업을 효율적으로 관리하기 위해 제공하는 고성능 I/O 시스템이다. 서버나 네트워크 응용 프로그램에서 많은 클라이언트의 요청을 처리해야 할 때 사용된다.

## IOCP란 무엇인가?

I/O Completion Port는 작업을 비동기로 처리하고, 해당 작업이 완료되면 이를 효율적으로 통보받아 처리를 이어갈 수 있도록 설계된 Windows API 기능이다. IOCP는 아래와 같은 특징을 가지고 있다.

- **효율적인 리소스 사용:** 쓰레드 풀(Thread Pool)을 활용해 CPU 리소스를 효율적으로 관리.
- **비동기 처리:** 입출력 작업(예: 파일 읽기/쓰기, 네트워크 송수신 등)을 비동기로 처리.
- **다중 작업 처리:** 높은 동시성을 제공하여 대량의 작업을 효과적으로 처리.

> IOCP는 컴퓨터가 많은 일을 효율적으로 나눠서 빠르게 처리하도록 도와주는 특별한 시스템이다.
> 마치 상사가 여러 직원들에게 일을 나눠주고, 일이 끝나면 다시 모아서 확인하는 것과 비슷하다.

## IOCP의 동작 원리

### 1. IOCP 생성

- CreateIoCompletionPort 함수를 호출하여 IOCP를 생성한다.
- 파일, 소켓 등의 핸들을 특정 IOCP와 연결한다.

```
HANDLE iocpHandle = CreateIoCompletionPort(INVALID_HANDLE_VALUE, NULL, 0, 0);
```

### 2. 비동기 작업 시작

- 입출력 작업을 비동기로 요청한다.
- 예를 들어, WSARecv(소켓) 또는 ReadFile(파일) 같은 함수 호출 시 비동기 I/O를 설정한다.

```
WSARecv(socket, &wsaBuf, 1, &bytesReceived, &flags, &overlapped, NULL);
```

### 3. 작업 완료 통보

- 비동기 작업이 완료되면 IOCP는 이를 대기 중인 쓰레드에 통보합니다.
- `GetQueuedCompletionStatus` 함수로 완료된 작업 정보를 가져옵니다.

  ```
  DWORD bytesTransferred;
  ULONG_PTR completionKey;
  OVERLAPPED\* pOverlapped;

  BOOL result = GetQueuedCompletionStatus(
    iocpHandle,
    &bytesTransferred,
    &completionKey,
    &pOverlapped,
    INFINITE
  );
  ```

### 4. 작업 후처리

- 쓰레드가 작업 완료 정보를 확인한 뒤 적절히 후속 작업(예: 데이터 처리)을 수행한다.

> 컴퓨터는 해야 할 많은 일을 생성된 IOCP에게 맡기고, IOCP는 각 쓰레드에게 일을 배분을 한다. 쓰레드가 일을 하는 처리하는 동안 IOCP는 다른 일을 준비하거나 기다린다.
> 그 후 쓰레드가 작업이 완료되면 통보를 하고 IOCP는 쓰레드가 완료한 작업을 모아서 확인 작업을 진행한다. 만약 잘못된게 있으면 다치 수정하도록 도와준다.

## IOCP의 주요 개념

### 1. Completion Key

- 핸들에 대한 고유 식별자로, 작업 완료 시 이를 통해 어떤 핸들에서 작업이 완료되었는지 알 수 있다.

### 2. OVERLAPPED 구조체

- 비동기 작업의 상태를 관리하는 데 사용되는 구조체입니다. 비동기 작업 요청 시 이 구조체를 함께 전달하며, 작업 완료 시 관련 데이터를 포함한다.

### 3. 쓰레드 풀(Thread Pool)

- IOCP는 쓰레드 풀을 사용하여 최소한의 쓰레드로 많은 클라이언트 요청을 처리한다.
- CPU 코어 수에 기반하여 동적으로 쓰레드 수를 조정한다.

> IOCP는 "누가 어떤 작업을 했는지" 기억한다. 그래서 일을 모아도 헷갈리지 않는다.
> 모든 직원들이 바쁘지 않게 도와준다. 어떤 직원은 너무 바쁘고, 어떤 직원은 할 일이 없는 일이 없도록 일을 잘 배분한다.

## IOCP의 장점

- **높은 성능:** 많은 수의 클라이언트를 동시에 처리하는 고성능 서버 구현 가능.
- **리소스 효율성:** 쓰레드 수를 동적으로 관리하여 오버헤드를 최소화.
- **확장성:** 대규모 네트워크 서비스나 파일 처리 작업에서도 확장성 제공.
- **비동기 작업 지원:** 네트워크와 파일 입출력 모두 비동기로 처리.

> 동시에 많은 일을 처리 할 수 있기에 속도가 빠르다.
> 한쪽에 부하가 가지 않도록 관리하며, 한 종류의 일만 할 수 있는게 아닌 여러 종류의 일도 가능하기에 효율성이 뛰어나다.

## IOCP를 사용하는 상황

IOCP는 아래와 같은 대규모 작업을 처리할 때 유용하다:

- **대규모 채팅 서버:** 수천 명의 클라이언트가 동시에 접속하는 환경.
- **파일 업로드/다운로드 서버:** 대량의 파일 처리 작업.
- **온라인 게임 서버:** 지속적인 데이터 송수신이 필요한 게임 환경.

## IOCP와 기타 I/O 모델 비교

| I/O 모델         | 특징                                                                         |
| ---------------- | ---------------------------------------------------------------------------- |
| Blocking I/O     | 작업 완료까지 쓰레드가 대기, 단순하지만 비효율적.                            |
| Non-blocking I/O | 작업 완료 여부를 수동으로 확인(polling), 쓰레드 사용은 줄어드나 복잡성 증가. |
| Overlapped I/O   | Windows에서 제공하는 비동기 I/O 방식, IOCP의 기반 기술.                      |
| IOCP             | 가장 효율적이고 확장성 있는 모델로, 대규모 시스템에서 주로 사용.             |

## 결론

IOCP는 대규모 비동기 작업을 처리하기 위한 최적의 I/O 모델이다. 효율적인 리소스 사용과 높은 확장성을 제공하여 서버 및 네트워크 프로그래밍에서 중요한 도구로 사용된다. 정확한 이해와 구현으로 고성능 애플리케이션을 개발할 수 있다.
